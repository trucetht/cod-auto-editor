name: Dependabot → Jira Bug

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  create-jira-bug:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Jira auth check (EX or Site)
        shell: bash
        env:
          JIRA_EX_BASE: ${{ vars.JIRA_EX_BASE }}
          JIRA_CLOUD_ID: ${{ vars.JIRA_CLOUD_ID }}
          JIRA_API_BASE: ${{ vars.JIRA_API_BASE }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          set -euo pipefail
          if [[ -n "${JIRA_EX_BASE:-}" && -n "${JIRA_CLOUD_ID:-}" ]]; then
            host=$(node -e "console.log(new URL(process.env.JIRA_EX_BASE).hostname)")
            path="/ex/jira/${JIRA_CLOUD_ID}/rest/api/3/myself"
          elif [[ -n "${JIRA_API_BASE:-}" ]]; then
            host=$(node -e "console.log(new URL(process.env.JIRA_API_BASE).hostname)")
            path="/rest/api/3/myself"
          else
            echo "::error::Missing Jira config (EX or Site)."
            exit 1
          fi
          code=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Accept: application/json" \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            "https://${host}${path}")
          echo "HTTP ${code}"
          if [ "$code" -ne 200 ]; then
            echo "::error title=Jira auth/scope failed::See response below"
            cat resp.json
            exit 1
          fi
          echo "OK: Token + scopes valid"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Create Jira ticket from Dependabot PR
        id: create-jira
        env:
          DEBUG: "true"
          USE_LLM: ${{ vars.USE_LLM }}                # e.g. true
          PREFERRED_MODEL: ${{ vars.PREFERRED_MODEL }} # e.g. openai/gpt-5-nano or your model id
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          JIRA_EX_BASE: ${{ vars.JIRA_EX_BASE }}
          JIRA_CLOUD_ID: ${{ vars.JIRA_CLOUD_ID }}
          JIRA_API_BASE: ${{ vars.JIRA_API_BASE }}

          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ vars.JIRA_PROJECT_KEY }}
          JIRA_ISSUE_TYPE: ${{ vars.JIRA_ISSUE_TYPE }}
          JIRA_DEFAULT_LABELS: ${{ vars.JIRA_DEFAULT_LABELS }}
          JIRA_STORY_POINTS_FIELD_ID: ${{ vars.JIRA_STORY_POINTS_FIELD_ID }}
          JIRA_STORY_POINTS_VALUE: ${{ vars.JIRA_STORY_POINTS_VALUE }}
          JIRA_BROWSE_BASE: ${{ vars.JIRA_BROWSE_BASE }}

          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_HTML_URL: ${{ github.event.pull_request.html_url }}
          REPO: ${{ github.repository }}
        run: node .github/workflows/scripts/create-jira-ticket-from-dependabot.ex.cjs

      - name: Comment PR with Jira link
        if: ${{ success() && steps.create-jira.outputs.jira_key != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "Jira bug created: **${{ steps.create-jira.outputs.jira_key }}** – ${{ steps.create-jira.outputs.jira_url }}"

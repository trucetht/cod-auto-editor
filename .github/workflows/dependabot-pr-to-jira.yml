name: Dependabot → Jira Bug

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write
  models: read   # lets GITHUB_TOKEN call models.github.ai

jobs:
  create-jira-bug:
    runs-on: ubuntu-latest
    env:
      # ---- Jira (Site API mode) ----
      JIRA_API_BASE: ${{ secrets.JIRA_API_BASE }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
      JIRA_BROWSE_BASE: ${{ secrets.JIRA_BROWSE_BASE }}
      # (Optional) issue type / points:
      JIRA_ISSUE_TYPE: Bug
      JIRA_STORY_POINTS_FIELD_ID: ""
      JIRA_STORY_POINTS_VALUE: ""

      # ---- LLM config ----
      USE_LLM: "true"
      # Set to a model you actually have access to (from your repo “Models” tab)
      # If your tab shows openai/gpt-5-nano, use that value exactly:
      PREFERRED_MODEL: "openai/gpt-5-nano"
      GH_MODELS_TOKEN: ${{ github.token }} # built-in token

      DEBUG: "true"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---- Preflight: Jira auth check (your current shell snippet) ----
      - name: Jira auth check
        shell: bash
        run: |
          set -euo pipefail
          if [[ -n "${JIRA_EX_BASE:-}" && -n "${JIRA_CLOUD_ID:-}" ]]; then
            host=$(node -e "console.log(new URL(process.env.JIRA_EX_BASE).hostname)")
            path="/ex/jira/${JIRA_CLOUD_ID}/rest/api/3/myself"
          elif [[ -n "${JIRA_API_BASE:-}" ]]; then
            host=$(node -e "console.log(new URL(process.env.JIRA_API_BASE).hostname)")
            path="/rest/api/3/myself"
          else
            echo "::error::Missing Jira config (EX or Site)."
            exit 1
          fi
          code=$(curl -sS -o resp.json -w "%{http_code}" \
            -H "Accept: application/json" \
            -u "${JIRA_EMAIL}:${JIRA_API_TOKEN}" \
            "https://${host}${path}")
          echo "HTTP ${code}"
          if [ "$code" -ne 200 ]; then
            echo "::error title=Jira auth/scope failed::See response below"
            cat resp.json
            exit 1
          fi
          echo "OK: Token + scopes valid"

      # ---- Run your Node script ----
      - name: Create Jira bug from Dependabot PR
        run: node .github/workflows/scripts/create-jira-ticket-from-dependabot.ex.cjs

      # (Optional) comment back on PR using outputs you set in the script)
      - name: Comment PR with Jira link
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ -f "$GITHUB_OUTPUT" ]]; then
            key=$(grep '^jira_key=' "$GITHUB_OUTPUT" | cut -d= -f2- || true)
            url=$(grep '^jira_url=' "$GITHUB_OUTPUT" | cut -d= -f2- || true)
            if [[ -n "$key" && -n "$url" ]]; then
              gh pr comment "${{ github.event.pull_request.number }}" --body "Jira bug created: **${key}** – ${url}"
            fi
          fi

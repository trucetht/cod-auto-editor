name: Models Healthcheck

on:
  workflow_dispatch:

jobs:
  ping-model:
    runs-on: ubuntu-latest
    permissions:
      contents: read         # enough to use GITHUB_TOKEN for Models
      pull-requests: read    # not required, but common default

    env:
      # Set the exact model you intend to use in your real workflow
      PREFERRED_MODEL: openai/gpt-5-mini
      # ^ or a pinned variant you have access to, e.g. openai/gpt-5-mini-2025-08-07

    steps:
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Call GitHub Models (chat.completions) with GITHUB_TOKEN
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}   # IMPORTANT: use the workflowâ€™s built-in token
        run: |
          set -euo pipefail
          node - <<'NODE'
          const https = require('https');

          const body = JSON.stringify({
            model: process.env.PREFERRED_MODEL || 'openai/gpt-5-mini',
            messages: [
              { role: 'system', content: 'You are a health check. Reply with only {"ok":true} as JSON.' },
              { role: 'user', content: 'Return exactly {"ok":true}' }
            ],
            temperature: 0
          });

          const req = https.request({
            hostname: 'models.github.ai',
            path: '/inference/chat/completions',
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${process.env.GITHUB_TOKEN}`,
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-GitHub-Api-Version': '2022-11-28',
              'User-Agent': 'actions-models-healthcheck'
            }
          }, res => {
            let data = '';
            res.on('data', c => data += c);
            res.on('end', () => {
              console.log('HTTP', res.statusCode);
              try {
                const json = JSON.parse(data);
                console.log(JSON.stringify(json, null, 2));
              } catch {
                console.log(data);
              }
              if (res.statusCode < 200 || res.statusCode >= 300) {
                console.error('Models call failed. See HTTP code/body above.');
                process.exit(1);
              }
              process.exit(0);
            });
          });

          req.on('error', (e) => {
            console.error('Request error:', e);
            process.exit(1);
          });

          req.write(body);
          req.end();
          NODE
